<!DOCTYPE html>
<html class="dark">
<head>
  <meta charset="utf-8"/>
  <title>AR Connect - Developer Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .loading { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(128,128,128,.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen">

<!-- Login Screen -->
<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
  <div class="bg-slate-800 p-10 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md">
    <div class="flex items-center justify-center mb-8">
      <div class="p-4 bg-blue-600 rounded-full">
        <span class="material-symbols-outlined text-white text-4xl">admin_panel_settings</span>
      </div>
    </div>
    <h1 class="text-3xl font-bold text-center mb-2 text-white">Developer Login</h1>
    <p class="text-gray-400 text-center mb-8 text-sm">AR Connect - LAH v3.0</p>
    
    <form onsubmit="handleLogin(event)" class="space-y-6">
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-300">Username</label>
        <input id="loginUsername" type="text" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white" placeholder="Enter username"/>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-300">Password</label>
        <input id="loginPassword" type="password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white" placeholder="Enter password"/>
      </div>
      <div id="loginError" class="hidden text-red-400 text-sm text-center p-3 bg-red-900/20 border border-red-800 rounded-lg"></div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all transform active:scale-95">
        <span id="loginBtnText">Access Dashboard</span>
        <span id="loginBtnLoading" class="loading hidden"></span>
      </button>
    </form>
    
    <div class="mt-8 pt-6 border-t border-slate-700 text-center">
      <a href="?" class="text-blue-400 hover:text-blue-300 text-sm flex items-center justify-center gap-2">
        <span class="material-symbols-outlined text-sm">arrow_back</span>
        Back to Main App
      </a>
    </div>
  </div>
</div>

<!-- Dashboard Screen -->
<div id="dashboardScreen" class="hidden">
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-900 to-blue-700 px-8 py-6 shadow-xl">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-white">Developer Dashboard</h1>
        <p class="text-blue-200 text-sm mt-1">AR Connect - System Monitoring & Logs</p>
      </div>
      <div class="flex items-center gap-4">
        <button onclick="refreshAllData()" class="p-3 bg-blue-800 hover:bg-blue-900 rounded-lg transition-all">
          <span class="material-symbols-outlined text-white">refresh</span>
        </button>
        <button onclick="closeDeveloper()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-medium transition-all">
          Close
        </button>
        <button onclick="logout()" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-all">
          Logout
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-8 py-8 space-y-8">
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <div class="flex items-center gap-3 mb-3">
          <span class="material-symbols-outlined text-blue-400 text-3xl">group</span>
          <div>
            <p class="text-xs text-gray-400 uppercase">Active Users</p>
            <p class="text-2xl font-bold text-white" id="statActiveUsers">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <div class="flex items-center gap-3 mb-3">
          <span class="material-symbols-outlined text-green-400 text-3xl">moving</span>
          <div>
            <p class="text-xs text-gray-400 uppercase">Total Actions</p>
            <p class="text-2xl font-bold text-white" id="statTotalActions">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <div class="flex items-center gap-3 mb-3">
          <span class="material-symbols-outlined text-amber-400 text-3xl">warning</span>
          <div>
            <p class="text-xs text-gray-400 uppercase">Errors</p>
            <p class="text-2xl font-bold text-white" id="statErrors">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <div class="flex items-center gap-3 mb-3">
          <span class="material-symbols-outlined text-purple-400 text-3xl">update</span>
          <div>
            <p class="text-xs text-gray-400 uppercase">Last Activity</p>
            <p class="text-sm font-bold text-white" id="statLastActivity">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
      <div class="flex border-b border-slate-700">
        <button onclick="switchTab('users')" id="tabUsers" class="flex-1 px-6 py-4 font-medium text-center border-b-2 border-blue-600 text-blue-400 bg-slate-900/50">
          <span class="material-symbols-outlined align-middle mr-2">people</span>
          User Activity
        </button>
        <button onclick="switchTab('logs')" id="tabLogs" class="flex-1 px-6 py-4 font-medium text-center border-b-2 border-transparent text-gray-400 hover:text-white hover:bg-slate-700/50">
          <span class="material-symbols-outlined align-middle mr-2">list_alt</span>
          Activity Logs
        </button>
        <button onclick="switchTab('system')" id="tabSystem" class="flex-1 px-6 py-4 font-medium text-center border-b-2 border-transparent text-gray-400 hover:text-white hover:bg-slate-700/50">
          <span class="material-symbols-outlined align-middle mr-2">settings</span>
          System Info
        </button>
        <button onclick="switchTab('api')" id="tabApi" class="flex-1 px-6 py-4 font-medium text-center border-b-2 border-transparent text-gray-400 hover:text-white hover:bg-slate-700/50">
          <span class="material-symbols-outlined align-middle mr-2">api</span>
          API Management
        </button>
      </div>

      <!-- Users Tab -->
      <div id="contentUsers" class="p-6">
        <div class="mb-4 flex justify-between items-center">
          <h2 class="text-xl font-bold text-white">Active Users</h2>
          <span class="text-sm text-gray-400" id="userCount">Loading...</span>
        </div>
        <div id="usersTable" class="space-y-3">
          <div class="flex justify-center py-10"><div class="loading"></div></div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="contentLogs" class="p-6 hidden">
        <div class="mb-4 flex justify-between items-center">
          <h2 class="text-xl font-bold text-white">Activity Logs</h2>
          <div class="flex gap-2">
            <select id="logFilter" onchange="filterLogs()" class="bg-slate-700 border-slate-600 rounded-lg px-3 py-2 text-sm text-white">
              <option value="all">All Actions</option>
              <option value="SEARCH">Search</option>
              <option value="ACCOUNT_UPDATE">Updates</option>
              <option value="EXPORT">Exports</option>
              <option value="ERROR">Errors</option>
            </select>
            <button onclick="loadLogs()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium">
              <span class="material-symbols-outlined text-sm align-middle">refresh</span>
              Refresh
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-900 text-left text-xs uppercase text-gray-400">
              <tr>
                <th class="px-4 py-3">Timestamp</th>
                <th class="px-4 py-3">User</th>
                <th class="px-4 py-3">Action</th>
                <th class="px-4 py-3">Details</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Page</th>
                <th class="px-4 py-3">Visit ID</th>
              </tr>
            </thead>
            <tbody id="logsTableBody" class="text-sm divide-y divide-slate-700">
              <tr><td colspan="7" class="p-10 text-center"><div class="loading mx-auto"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Access Control Tab -->
      <div id="contentAccess" class="p-6 hidden">
        <div class="mb-4 flex justify-between items-center">
          <h2 class="text-xl font-bold text-white">User Access Management</h2>
          <button onclick="showAddUserModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium">
            <span class="material-symbols-outlined text-sm align-middle mr-1">add</span>
            Add User
          </button>
        </div>
        <div id="accessUsersTable" class="space-y-3">
          <div class="flex justify-center py-10"><div class="loading"></div></div>
        </div>
      </div>

      <!-- Non-Workable Tab -->
      <div id="contentNonWorkable" class="p-6 hidden">
        <div class="mb-4 flex justify-between items-center">
          <h2 class="text-xl font-bold text-white">Non-Workable Accounts</h2>
          <div class="flex gap-2">
            <select id="nonWorkableFilter" onchange="filterNonWorkable()" class="bg-slate-700 border-slate-600 rounded-lg px-3 py-2 text-sm text-white">
              <option value="all">All</option>
              <option value="pending">Pending Approval</option>
              <option value="approved">Approved</option>
              <option value="denied">Denied</option>
            </select>
            <button onclick="loadNonWorkableAccounts()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium">
              <span class="material-symbols-outlined text-sm align-middle">refresh</span>
              Refresh
            </button>
          </div>
        </div>
        <div id="nonWorkableTable" class="space-y-3">
          <div class="flex justify-center py-10"><div class="loading"></div></div>
        </div>
      </div>

      <!-- API Management Tab -->
      <div id="contentApi" class="p-6 hidden">
        <h2 class="text-xl font-bold text-white mb-6">JSON Conversion</h2>
        <div class="space-y-6">
          <div class="bg-slate-700/50 p-6 rounded-lg border border-slate-600">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-green-400">sync</span>
              JSON Conversion
            </h3>
            <div class="space-y-4">
              <div class="flex gap-2">
                <button onclick="convertAllSheetsDev()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium">
                  Convert All Sheets
                </button>
                <button onclick="refreshJsonDataDev()" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-sm font-medium">
                  Refresh JSON Data
                </button>
              </div>
              <div id="jsonConversionStatus" class="text-sm text-gray-400"></div>
              <div id="jsonConversionResults" class="mt-4 space-y-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Tab -->
      <div id="contentSystem" class="p-6 hidden">
        <h2 class="text-xl font-bold text-white mb-6">System Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-slate-700/50 p-6 rounded-lg border border-slate-600">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-blue-400">storage</span>
              Cache Status
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Cache Duration:</span>
                <span class="text-white font-medium">5 minutes</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Auto Refresh:</span>
                <span class="text-green-400 font-medium">Enabled</span>
              </div>
            </div>
          </div>
          
          <div class="bg-slate-700/50 p-6 rounded-lg border border-slate-600">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-purple-400">security</span>
              Security
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Activity Logging:</span>
                <span class="text-green-400 font-medium">Active</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Auth Method:</span>
                <span class="text-white font-medium">Google Apps Script</span>
              </div>
            </div>
          </div>
          
          <div class="bg-slate-700/50 p-6 rounded-lg border border-slate-600 md:col-span-2">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-amber-400">info</span>
              Application Info
            </h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div><span class="text-gray-400">Version:</span> <span class="text-white font-medium">3.0 Advanced</span></div>
              <div><span class="text-gray-400">Build:</span> <span class="text-white font-medium">2024.12</span></div>
              <div><span class="text-gray-400">Environment:</span> <span class="text-white font-medium">Production</span></div>
              <div><span class="text-gray-400">Sheet ID:</span> <span class="text-white font-mono text-xs">1DFFkBfPAwtq...</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let allLogs = [];
let filteredLogs = [];
let isAuthenticated = false;

// Check if already authenticated (session)
function checkAuth() {
  const authStatus = sessionStorage.getItem('dev_authenticated');
  if (authStatus === 'true') {
    isAuthenticated = true;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.remove('hidden');
    loadDashboardData();
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  checkAuth();
});

function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const btnText = document.getElementById('loginBtnText');
  const btnLoading = document.getElementById('loginBtnLoading');
  const errorDiv = document.getElementById('loginError');
  
  btnText.classList.add('hidden');
  btnLoading.classList.remove('hidden');
  errorDiv.classList.add('hidden');
  
  // Check if google.script is available
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    // Mock for testing
    if (username === 'Blake Dawson' && password === 'Root') {
      isAuthenticated = true;
      sessionStorage.setItem('dev_authenticated', 'true');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.remove('hidden');
      loadDashboardData();
      return;
    } else {
      errorDiv.textContent = 'Invalid credentials. Please try again.';
      errorDiv.classList.remove('hidden');
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
      return;
    }
  }
  
  google.script.run
    .withSuccessHandler(result => {
      if (result) {
        isAuthenticated = true;
        sessionStorage.setItem('dev_authenticated', 'true');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboardScreen').classList.remove('hidden');
        loadDashboardData();
      } else {
        errorDiv.textContent = 'Invalid credentials. Please try again.';
        errorDiv.classList.remove('hidden');
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }
    })
    .withFailureHandler(err => {
      errorDiv.textContent = 'Login failed: ' + err.message;
      errorDiv.classList.remove('hidden');
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
    })
    .authenticateDeveloper(username, password);
}

function closeLoginModal() {
  window.location.href = '?';
}

function closeDeveloper() {
  window.location.href = '?';
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    sessionStorage.removeItem('dev_authenticated');
    isAuthenticated = false;
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('dashboardScreen').classList.add('hidden');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
  }
}

function loadDashboardData() {
  loadUsers();
  loadLogs();
  loadStats();
}

function loadUsers() {
  const container = document.getElementById('usersTable');
  if (container) {
    container.innerHTML = '<div class="flex justify-center py-10"><div class="loading"></div></div>';
  }
  
  // Mock data for testing if google.script not available
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    const mockUsers = [
      { name: 'Test User', email: 'test@example.com', totalActions: 50, lastSeen: '12/15/2024', firstSeen: '12/01/2024', sessions: 5, errors: 2, pages: ['Index'], actions: { 'SEARCH': 20, 'ACCOUNT_UPDATE': 15, 'PAGE_LOAD': 15 } }
    ];
    displayUsers(mockUsers);
    return;
  }
  
  google.script.run
    .withSuccessHandler(users => {
      displayUsers(users);
    })
    .withFailureHandler(err => {
      console.error('Error loading users:', err);
      if (container) {
        container.innerHTML = '<p class="text-red-400 text-center py-8">Error loading user data: ' + err.message + '</p>';
      }
    })
    .getUserStatistics();
}

function displayUsers(users) {
      document.getElementById('userCount').textContent = `${users.length} users`;
      document.getElementById('statActiveUsers').textContent = users.length;
      
      const container = document.getElementById('usersTable');
      if (users.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">No user data available</p>';
        return;
      }
      
      // Sort by last seen (most recent first)
      users.sort((a, b) => {
        try {
          return new Date(b.lastSeenRaw || b.lastSeen) - new Date(a.lastSeenRaw || a.lastSeen);
        } catch(e) {
          return 0;
        }
      });
      
      container.innerHTML = users.map(user => {
        const firstSeen = user.firstSeen || 'N/A';
        const lastSeen = user.lastSeen || 'N/A';
        const sessions = user.sessions || 0;
        const errors = user.errors || 0;
        const pages = user.pages || [];
        
        return `
        <div class="bg-slate-700/50 p-5 rounded-lg border border-slate-600 hover:border-slate-500 transition-all">
          <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
              <p class="font-bold text-white text-lg">${user.name}</p>
              <p class="text-xs text-gray-400 mt-1">${user.email}</p>
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="px-3 py-1 bg-green-900/30 text-green-400 text-xs font-medium rounded-full border border-green-800">
                Active
              </span>
              ${errors > 0 ? `<span class="px-2 py-1 bg-red-900/30 text-red-400 text-xs font-medium rounded-full border border-red-800">${errors} Errors</span>` : ''}
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-xs">
            <div class="bg-slate-800/50 p-3 rounded-lg">
              <p class="text-gray-400 mb-1">Total Actions</p>
              <p class="text-white font-bold text-xl">${user.totalActions}</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-lg">
              <p class="text-gray-400 mb-1">Sessions</p>
              <p class="text-white font-bold text-xl">${sessions}</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-lg">
              <p class="text-gray-400 mb-1">First Seen</p>
              <p class="text-white font-medium text-sm">${firstSeen}</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-lg">
              <p class="text-gray-400 mb-1">Last Seen</p>
              <p class="text-white font-medium text-sm">${lastSeen}</p>
            </div>
          </div>
          
          ${pages.length > 0 ? `
          <div class="mb-3 pt-3 border-t border-slate-600">
            <p class="text-xs text-gray-400 mb-2">Pages Accessed:</p>
            <div class="flex flex-wrap gap-2">
              ${pages.map(page => `<span class="px-2 py-1 bg-blue-900/30 text-blue-400 text-xs rounded border border-blue-800">${page}</span>`).join('')}
            </div>
          </div>
          ` : ''}
          
          <div class="pt-3 border-t border-slate-600">
            <p class="text-xs text-gray-400 mb-2">Top Actions:</p>
            <div class="flex flex-wrap gap-2">
              ${Object.entries(user.actions || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([action, count]) => 
                  `<span class="px-2 py-1 bg-slate-600 text-white text-xs rounded" title="${action}: ${count} times">${action}: ${count}</span>`
                ).join('')}
            </div>
          </div>
        </div>
      `;
      }).join('');
}

function loadLogs() {
  const tbody = document.getElementById('logsTableBody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center"><div class="loading mx-auto"></div></td></tr>';
  }
  
  // Mock data for testing if google.script not available
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    const mockLogs = [
      { timestamp: '12/15/2024 10:30 AM', email: 'test@example.com', name: 'Test User', action: 'SEARCH', details: 'Visit ID: 12345', status: 'SUCCESS', page: 'Index', visitId: '12345' }
    ];
    displayLogs(mockLogs);
    updateStatsFromLogs(mockLogs);
    return;
  }
  
  google.script.run
    .withSuccessHandler(logs => {
      allLogs = logs || [];
      filteredLogs = logs || [];
      displayLogs(filteredLogs);
      
      const errors = filteredLogs.filter(l => l.status === 'ERROR' || l.status === 'FAILED').length;
      if (document.getElementById('statErrors')) {
        document.getElementById('statErrors').textContent = errors;
      }
      if (document.getElementById('statTotalActions')) {
        document.getElementById('statTotalActions').textContent = filteredLogs.length;
      }
      if (filteredLogs.length > 0 && document.getElementById('statLastActivity')) {
        document.getElementById('statLastActivity').textContent = filteredLogs[0].timestamp || '-';
      }
    })
    .withFailureHandler(err => {
      console.error('Error loading logs:', err);
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-red-400">Error loading logs: ' + (err.message || err) + '</td></tr>';
      }
    })
    .getActivityLogs(200);
}

function updateStatsFromLogs(logs) {
  const errors = logs.filter(l => l.status === 'ERROR').length;
  document.getElementById('statErrors').textContent = errors;
  document.getElementById('statTotalActions').textContent = logs.length;
  if (logs.length > 0) {
    document.getElementById('statLastActivity').textContent = logs[0].timestamp;
  }
}

function displayLogs(logs) {
  const tbody = document.getElementById('logsTableBody');
  
  if (logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">No logs available</td></tr>';
    return;
  }
  
  tbody.innerHTML = logs.map(log => {
    const statusColor = log.status === 'ERROR' ? 'text-red-400 bg-red-900/20 border-red-800' : 
                        log.status === 'FAILED' ? 'text-amber-400 bg-amber-900/20 border-amber-800' : 
                        'text-green-400 bg-green-900/20 border-green-800';
    
    return `
      <tr class="hover:bg-slate-700/50">
        <td class="px-4 py-3 text-gray-300 text-xs">${log.timestamp || 'N/A'}</td>
        <td class="px-4 py-3">
          <div class="text-white font-medium text-sm">${log.name || 'Unknown'}</div>
          <div class="text-xs text-gray-400">${log.email || 'N/A'}</div>
        </td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 bg-blue-900/30 text-blue-400 text-xs font-medium rounded border border-blue-800">
            ${log.action || 'N/A'}
          </span>
        </td>
        <td class="px-4 py-3 text-gray-300 max-w-md truncate text-xs" title="${log.details || ''}">${log.details || 'N/A'}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-medium rounded border ${statusColor}">
            ${log.status || 'SUCCESS'}
          </span>
        </td>
        <td class="px-4 py-3 text-xs text-gray-400">
          ${log.page || 'Index'}
        </td>
        <td class="px-4 py-3 text-xs text-gray-400">
          ${log.visitId || '-'}
        </td>
      </tr>
    `;
  }).join('');
}

function filterLogs() {
  const filter = document.getElementById('logFilter').value;
  
  if (filter === 'all') {
    filteredLogs = allLogs;
  } else if (filter === 'ERROR') {
    filteredLogs = allLogs.filter(l => l.status === 'ERROR' || l.status === 'FAILED');
  } else {
    filteredLogs = allLogs.filter(l => l.action.includes(filter));
  }
  
  displayLogs(filteredLogs);
}

function loadStats() {
  // Already loaded with logs and users
}

function switchTab(tab) {
  // Hide all content
  const tabs = ['users', 'logs', 'access', 'nonworkable', 'system', 'api'];
  tabs.forEach(t => {
    const contentEl = document.getElementById('content' + t.charAt(0).toUpperCase() + t.slice(1));
    const tabEl = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
    if (contentEl) contentEl.classList.add('hidden');
    if (tabEl) {
      tabEl.className = 'flex-1 px-6 py-4 font-medium text-center border-b-2 border-transparent text-gray-400 hover:text-white hover:bg-slate-700/50';
    }
  });
  
  // Show selected
  const contentId = 'content' + tab.charAt(0).toUpperCase() + tab.slice(1);
  const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
  const contentEl = document.getElementById(contentId);
  const tabEl = document.getElementById(tabId);
  
  if (contentEl) contentEl.classList.remove('hidden');
  if (tabEl) tabEl.className = 'flex-1 px-6 py-4 font-medium text-center border-b-2 border-blue-600 text-blue-400 bg-slate-900/50';
  
  // Load data when switching to API tab
  if (tab === 'api') {
    // Tab is ready
  }
  
  // Load data for specific tabs
  if (tab === 'access') {
    loadAccessUsers();
  } else if (tab === 'nonworkable') {
    loadNonWorkableAccounts();
  }
}

function refreshAllData() {
  loadDashboardData();
  const btn = event.target.closest('button');
  btn.classList.add('animate-spin');
  setTimeout(() => btn.classList.remove('animate-spin'), 1000);
}

// Access Control Functions
function loadAccessUsers() {
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    document.getElementById('accessUsersTable').innerHTML = '<p class="text-gray-400 text-center py-8">Google Script not available</p>';
    return;
  }
  
  google.script.run
    .withSuccessHandler(users => {
      displayAccessUsers(users);
    })
    .withFailureHandler(err => {
      console.error('Error loading access users:', err);
      document.getElementById('accessUsersTable').innerHTML = '<p class="text-red-400 text-center py-8">Error loading users</p>';
    })
    .getAllAccessUsers();
}

function displayAccessUsers(users) {
  const container = document.getElementById('accessUsersTable');
  if (users.length === 0) {
    container.innerHTML = '<p class="text-gray-400 text-center py-8">No users found</p>';
    return;
  }
  
  container.innerHTML = users.map(user => `
    <div class="bg-slate-700/50 p-5 rounded-lg border border-slate-600">
      <div class="flex justify-between items-start mb-4">
        <div class="flex-1">
          <p class="font-bold text-white text-lg">${user.name}</p>
          <p class="text-xs text-gray-400 mt-1">${user.email}</p>
        </div>
        <div class="flex gap-2">
          <span class="px-3 py-1 bg-blue-900/30 text-blue-400 text-xs font-medium rounded-full border border-blue-800">
            ${user.role}
          </span>
          <span class="px-3 py-1 ${user.status === 'Active' ? 'bg-green-900/30 text-green-400 border-green-800' : 'bg-red-900/30 text-red-400 border-red-800'} text-xs font-medium rounded-full border">
            ${user.status}
          </span>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4 text-xs">
        <div>
          <p class="text-gray-400">Version</p>
          <p class="text-white font-medium">${user.version || 'Unknown'}</p>
        </div>
        <div>
          <p class="text-gray-400">Last Access</p>
          <p class="text-white font-medium">${user.lastAccess || 'Never'}</p>
        </div>
      </div>
      <div class="flex gap-2 pt-3 border-t border-slate-600">
        <button onclick="approveUserAccess('${user.email}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">Approve</button>
        <button onclick="blockUserAccess('${user.email}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">Block</button>
        <button onclick="deleteUserAccess('${user.email}')" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs">Delete</button>
      </div>
    </div>
  `).join('');
}

function showAddUserModal() {
  const email = prompt('Enter user email:');
  if (!email) return;
  
  const role = prompt('Enter role (User/Lead/QC/Developer/Lead):', 'User');
  if (!role) return;
  
  const tabsInput = prompt('Enter allowed tabs (comma-separated, e.g., assigned,searchResults,totalWorked):', 'assigned,searchResults');
  const tabs = tabsInput ? tabsInput.split(',').map(t => t.trim()) : ['assigned', 'searchResults'];
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        if (result.success) {
          alert('User added successfully');
          loadAccessUsers();
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(err => alert('Error: ' + err.message))
      .grantAccess(email, role, tabs);
  }
}

function approveUserAccess(email) {
  if (!confirm(`Approve access for ${email}?`)) return;
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        alert(result.message);
        loadAccessUsers();
      })
      .withFailureHandler(err => alert('Error: ' + err.message))
      .grantAccess(email, 'User', ['assigned', 'searchResults']);
  }
}

function blockUserAccess(email) {
  if (!confirm(`Block access for ${email}?`)) return;
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        alert(result.message);
        loadAccessUsers();
      })
      .withFailureHandler(err => alert('Error: ' + err.message))
      .revokeAccess(email);
  }
}

function deleteUserAccess(email) {
  if (!confirm(`Delete access for ${email}? This cannot be undone.`)) return;
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        alert(result.message);
        loadAccessUsers();
      })
      .withFailureHandler(err => alert('Error: ' + err.message))
      .revokeAccess(email);
  }
}

// Non-Workable Functions
function loadNonWorkableAccounts() {
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    document.getElementById('nonWorkableTable').innerHTML = '<p class="text-gray-400 text-center py-8">Google Script not available</p>';
    return;
  }
  
  google.script.run
    .withSuccessHandler(accounts => {
      displayNonWorkableAccounts(accounts);
    })
    .withFailureHandler(err => {
      console.error('Error loading non-workable accounts:', err);
      document.getElementById('nonWorkableTable').innerHTML = '<p class="text-red-400 text-center py-8">Error loading accounts</p>';
    })
    .getNonWorkableAccounts();
}

function displayNonWorkableAccounts(accounts) {
  const container = document.getElementById('nonWorkableTable');
  if (accounts.length === 0) {
    container.innerHTML = '<p class="text-gray-400 text-center py-8">No non-workable accounts found</p>';
    return;
  }
  
  container.innerHTML = accounts.map(acc => `
    <div class="bg-slate-700/50 p-5 rounded-lg border border-slate-600">
      <div class="flex justify-between items-start mb-4">
        <div class="flex-1">
          <p class="font-bold text-white text-lg">${acc.patientName || 'N/A'}</p>
          <p class="text-xs text-gray-400 mt-1">Visit ID: ${acc.visitId}</p>
          <p class="text-xs text-gray-400">Client: ${acc.client || 'N/A'}</p>
        </div>
        <div class="text-right">
          <p class="text-lg font-bold text-red-400">${formatCurrency(acc.balanceAmount || 0)}</p>
        </div>
      </div>
      <div class="mb-4">
        <p class="text-xs text-gray-400 mb-1">Remarks</p>
        <p class="text-sm text-white">${acc.remarks || 'No remarks'}</p>
      </div>
      <div class="flex gap-2">
        <button onclick="approveNonWorkable('${acc.visitId}')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm">Approve</button>
        <button onclick="denyNonWorkable('${acc.visitId}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm">Deny</button>
      </div>
    </div>
  `).join('');
}

function approveNonWorkable(visitId) {
  const comment = prompt('Enter approval comment:');
  if (comment === null) return;
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        if (result.success) {
          alert('Non-workable account approved');
          loadNonWorkableAccounts();
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(err => alert('Error: ' + err.message))
      .approveNonWorkable(visitId, comment, Session.getActiveUser().getEmail());
  }
}

function denyNonWorkable(visitId) {
  const comment = prompt('Enter denial comment:');
  if (comment === null) return;
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        if (result.success) {
          alert('Non-workable account denied');
          loadNonWorkableAccounts();
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(err => alert('Error: ' + err.message))
      .denyNonWorkable(visitId, comment, Session.getActiveUser().getEmail());
  }
}

function filterNonWorkable() {
  // Implementation would filter the displayed accounts
  loadNonWorkableAccounts();
}

function formatCurrency(n) {
  return '$' + parseFloat(n||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// ============================================
// JSON CONVERSION FUNCTIONS
// ============================================

function convertAllSheetsDev() {
  updateJsonConversionStatus('Converting all sheets...', 'info');
  document.getElementById('jsonConversionResults').innerHTML = '';
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        if (result && result.success) {
          updateJsonConversionStatus('Conversion completed successfully!', 'success');
          displayJsonConversionResults(result);
        } else {
          updateJsonConversionStatus('Conversion failed: ' + (result.error || 'Unknown error'), 'error');
        }
      })
      .withFailureHandler(err => {
        updateJsonConversionStatus('Error: ' + err.message, 'error');
      })
      .convertAllClientSheetsToJSON();
  }
}

function refreshJsonDataDev() {
  updateJsonConversionStatus('Refreshing JSON data...', 'info');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(result => {
        if (result && result.success) {
          updateJsonConversionStatus('JSON data refreshed successfully!', 'success');
          displayJsonConversionResults(result);
        } else {
          updateJsonConversionStatus('Refresh failed: ' + (result.error || 'Unknown error'), 'error');
        }
      })
      .withFailureHandler(err => {
        updateJsonConversionStatus('Error: ' + err.message, 'error');
      })
      .refreshAllJSONData();
  }
}

function updateJsonConversionStatus(message, type) {
  const statusEl = document.getElementById('jsonConversionStatus');
  if (statusEl) {
    statusEl.textContent = message;
    statusEl.className = 'text-sm ' + (
      type === 'success' ? 'text-green-400' :
      type === 'error' ? 'text-red-400' :
      type === 'info' ? 'text-blue-400' :
      'text-gray-400'
    );
  }
}

function displayJsonConversionResults(result) {
  const resultsEl = document.getElementById('jsonConversionResults');
  if (!resultsEl || !result.summary) return;
  
  const summary = result.summary;
  resultsEl.innerHTML = `
    <div class="bg-slate-800 p-4 rounded-lg border border-slate-600">
      <h4 class="font-bold text-white mb-3">Conversion Summary</h4>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-gray-400">Total Clients:</span>
          <span class="text-white font-medium ml-2">${summary.totalClients || 0}</span>
        </div>
        <div>
          <span class="text-gray-400">Successful:</span>
          <span class="text-green-400 font-medium ml-2">${summary.successful || 0}</span>
        </div>
        <div>
          <span class="text-gray-400">Failed:</span>
          <span class="text-red-400 font-medium ml-2">${summary.failed || 0}</span>
        </div>
        <div>
          <span class="text-gray-400">Total Rows:</span>
          <span class="text-white font-medium ml-2">${summary.totalRows || 0}</span>
        </div>
        <div>
          <span class="text-gray-400">Conversion Time:</span>
          <span class="text-white font-medium ml-2">${summary.conversionTime || 0}ms</span>
        </div>
      </div>
    </div>
  `;
}
</script>

</body>
</html>
